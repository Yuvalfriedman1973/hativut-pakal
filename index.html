<!doctype html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; max-width: 900px; }
      h1 { font-size: 20px; margin: 0 0 8px; }
      .note { color: #444; margin: 0 0 16px; }
      .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; }
      label { display: block; margin: 8px 0 4px; }
      input { width: 100%; padding: 10px; box-sizing: border-box; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: right; }
      th { background: #fafafa; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .btn { padding: 10px 12px; border: 0; border-radius: 10px; cursor: pointer; }
      .btnPrimary { background: #111; color: #fff; }
      .btnGhost { background: #f2f2f2; }
      .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
      .muted { color: #666; font-size: 13px; }
      .err { color: #b00020; }
      .ok { color: #0b7a0b; }
      .qty { width: 90px; }
      .ltr { direction: ltr; }
    </style>
  </head>
  <body dir="rtl">
    <h1>שיבוץ הבאת אוכל – משפחת "ישראלי" (09.01.2026)</h1>
    <p class="note">בחר/י פריטים להתחייבות. המלאי מתעדכן בזמן אמת – פריט שאזל לא יופיע.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>שם מלא *</label>
          <input id="name" placeholder="לדוגמה: יובל פרידמן" />
        </div>
        <div>
          <label>טלפון (אופציונלי)</label>
          <input id="phone" class="ltr" placeholder="05x-xxxxxxx" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="actions">
        <button class="btn btnGhost" onclick="reload()">רענון רשימה</button>
        <button class="btn btnPrimary" onclick="submit()">שליחה</button>
      </div>
      <p id="status" class="muted"></p>
    </div>

    <div class="card">
      <h2 style="font-size:16px; margin:0 0 8px;">פריטים זמינים</h2>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>פריט</th>
              <th>נותר</th>
              <th>יחידה</th>
              <th>כמות להתחייבות</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>
      <p class="muted">טיפ: אם נשאר 1 ואת/ה לוקח/ת 1 – אחרי השליחה הפריט ייעלם מהרשימה.</p>
    </div>

    <div class="card">
      <h2 style="font-size:16px; margin:0 0 8px;">הורדת שיבוצים</h2>
      <div class="actions">
        <button class="btn btnGhost" onclick="downloadXlsx()">Excel</button>
        <button class="btn btnGhost" onclick="downloadPdf()">PDF</button>
      </div>
      <p class="muted">הקבצים נוצרים כקובץ חדש ב-Drive ומוחזר קישור להורדה.</p>
      <p id="dl" class="muted"></p>
    </div>

    <script>
      let currentItems = [];

      function setStatus(msg, kind) {
        const el = document.getElementById("status");
        el.className = (kind === "err") ? "err" : (kind === "ok" ? "ok" : "muted");
        el.textContent = msg || "";
      }

      function render(items) {
        const body = document.getElementById("itemsBody");
        body.innerHTML = "";
        currentItems = items;

        for (const it of items) {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${escapeHtml(it.itemName)}</td>
            <td>${it.remainingQty}</td>
            <td>${escapeHtml(it.unit || "")}</td>
            <td>
              <input class="qty ltr" type="number" min="0" step="1"
                     max="${it.remainingQty}" data-itemid="${it.itemId}"
                     placeholder="0" />
            </td>
          `;
          body.appendChild(tr);
        }

        setStatus(`נטענו ${items.length} פריטים זמינים.`, "ok");
      }

      function reload() {
        setStatus("טוען פריטים…");
        google.script.run
          .withSuccessHandler(render)
          .withFailureHandler(err => setStatus(err.message || String(err), "err"))
          .getAvailableItems();
      }

      function submit() {
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();

        const inputs = [...document.querySelectorAll("input[data-itemid]")];
        const selections = inputs
          .map(inp => ({ itemId: inp.dataset.itemid, qty: Number(inp.value) }))
          .filter(x => Number.isFinite(x.qty) && x.qty > 0);

        if (!name) return setStatus("חובה למלא שם מלא.", "err");
        if (selections.length === 0) return setStatus("בחר/י לפחות פריט אחד עם כמות גדולה מ-0.", "err");

        // client-side max check
        for (const s of selections) {
          const it = currentItems.find(x => x.itemId === s.itemId);
          if (it && s.qty > it.remainingQty) {
            return setStatus(`הכמות שבחרת גדולה מהמלאי שנותר עבור "${it.itemName}".`, "err");
          }
        }

        setStatus("שולח…");
        google.script.run
          .withSuccessHandler(() => {
            setStatus("נקלט בהצלחה! הרשימה תתרענן.", "ok");
            reload();
          })
          .withFailureHandler(err => setStatus(err.message || String(err), "err"))
          .submitAssignment({ name, phone, selections });
      }

      function downloadXlsx() {
        document.getElementById("dl").textContent = "מכין קובץ Excel…";
        google.script.run
          .withSuccessHandler(res => {
            document.getElementById("dl").innerHTML = `Excel מוכן: <a href="${res.url}" target="_blank">פתח/י</a>`;
          })
          .withFailureHandler(err => {
            document.getElementById("dl").textContent = "שגיאה: " + (err.message || String(err));
          })
          .exportAssignmentsXlsx();
      }

      function downloadPdf() {
        document.getElementById("dl").textContent = "מכין PDF…";
        google.script.run
          .withSuccessHandler(res => {
            document.getElementById("dl").innerHTML = `PDF מוכן: <a href="${res.url}" target="_blank">פתח/י</a>`;
          })
          .withFailureHandler(err => {
            document.getElementById("dl").textContent = "שגיאה: " + (err.message || String(err));
          })
          .exportAssignmentsPdf();
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, c => ({
          "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
        }[c]));
      }

      reload();
    </script>
  </body>
</html>
